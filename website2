<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hobbs House Bakery – Product Balance Framework</title>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#101824;
      --muted:#9db0c6;
      --text:#eef4fb;
      --line:#223349;

      --brand:#f26a21;      /* Hobbs orange */
      --brand2:#ff8a3d;
      --brand3:#ffb27a;

      --good:#59d18a;
      --warn:#ffd166;
      --bad:#ff6b6b;

      --shadow: 0 14px 55px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 8%, rgba(242,106,33,.30) 0%, transparent 55%),
        radial-gradient(1000px 650px at 90% 10%, rgba(255,138,61,.18) 0%, transparent 50%),
        radial-gradient(900px 600px at 70% 85%, rgba(255,178,122,.10) 0%, transparent 55%),
        var(--bg);
    }

    header{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 18px 10px;
      display:flex;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brandBlock{
      display:flex;
      align-items:flex-end;
      gap:14px;
    }

    .mark{
      width: 180px;
      height: auto;
      max-height: 56px;
      object-fit: contain;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }

    h1{
      margin:0;
      font-size: 20px;
      letter-spacing: .2px;
    }
    header p{
      margin:4px 0 0 0;
      color: var(--muted);
      max-width: 88ch;
      line-height: 1.45;
      font-size: 13px;
    }

    .topActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding: 12px 18px 46px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 1040px){
      .wrap{
        grid-template-columns: 460px 1fr;
        align-items:start;
      }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .card h2{
      margin:0 0 10px 0;
      font-size: 15px;
      color:#ffe7d7;
      letter-spacing:.2px;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tab{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.10);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
    }
    .tab.active{
      border-color: rgba(242,106,33,.65);
      background: rgba(242,106,33,.16);
      box-shadow: 0 10px 30px rgba(242,106,33,.12);
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 12px 0 6px;
    }

    input[type="text"], textarea, select{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-size: 13px;
    }
    textarea{ min-height: 80px; resize: vertical; }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .row .value{
      width: 34px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      color:#ffe7d7;
      font-weight:700;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--brand);
    }

    .hint{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(157,176,198,.95);
      line-height: 1.35;
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.09);
      margin: 12px 0;
    }

    .btn{
      border:0;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 700;
      font-size: 13px;
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand2) 60%, var(--brand3) 100%);
      color:#1b0b02;
      box-shadow: 0 12px 28px rgba(242,106,33,.22);
    }
    .btn.ghost{
      background: transparent;
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
    }
    .btn.small{
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 12px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .gridRight{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .chartWrap{ padding: 10px 12px 14px; }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color: #ffe7d7;
    }
    .chip.good{ border-color: rgba(89,209,138,.55); color: #c6f3da; }
    .chip.warn{ border-color: rgba(255,209,102,.55); color: #ffecc2; }
    .chip.bad{ border-color: rgba(255,107,107,.60); color: #ffd5d5; }

    .out h3{
      margin: 0 0 8px 0;
      font-size: 13px;
      color:#ffe7d7;
    }
    .out p, .out li{
      color: var(--muted);
      line-height: 1.45;
      font-size: 13px;
    }
    .out ul{ margin: 8px 0 0 18px; }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 1040px){
      .twoCol{ grid-template-columns: 1fr 1fr; }
    }

    .miniTitle{
      font-size: 12px;
      color: rgba(255,231,215,.9);
      font-weight: 750;
      letter-spacing: .2px;
      margin-bottom: 4px;
    }

    .footerNote{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(157,176,198,.92);
    }

    .hidden{ display:none !important; }

    /* Print-friendly */
    @media print{
      body{ background:#fff; color:#000; }
      header, .topActions, .tabs, .btn{ display:none !important; }
      .card{ box-shadow:none; border:1px solid #ddd; }
      .out p, .out li{ color:#000; }
    }
  </style>
</head>

<body>
<header>
  <div class="brandBlock">
    <!-- Optional logo: put a logo PNG next to this file named: logo.png -->
    <img class="mark" src="logo.png" alt="Hobbs House Bakery" onerror="this.style.display='none'"/>
    <div>
      <h1>Hobbs House Bakery – Product Balance Framework</h1>
      <p>Score a product across five lenses, apply the Brand Gate, record the decision, and generate a spider chart plus plain-English next steps. This is a decision lens, not a nutrition claims tool.</p>
    </div>
  </div>

  <div class="topActions">
    <button class="btn ghost small" id="btnSaveLocal" type="button">Save</button>
    <button class="btn ghost small" id="btnLoadLocal" type="button">Load</button>
    <button class="btn ghost small" id="btnExportJSON" type="button">Export JSON</button>
    <button class="btn ghost small" id="btnImportJSON" type="button">Import JSON</button>
    <button class="btn ghost small" id="btnDownloadSVG" type="button">Download chart (SVG)</button>
    <button class="btn ghost small" id="btnPrintPDF" type="button">Print / Save as PDF</button>
    <input type="file" id="jsonFile" accept="application/json" class="hidden" />
  </div>
</header>

<main class="wrap">
  <!-- LEFT: Inputs -->
  <section class="card" aria-label="Inputs">
    <div class="tabs" role="tablist" aria-label="Mode">
      <button class="tab active" id="tabSingle" type="button" role="tab" aria-selected="true">Single product</button>
      <button class="tab" id="tabCompare" type="button" role="tab" aria-selected="false">Compare two products</button>
    </div>

    <div class="divider"></div>

    <label for="productType">Product type</label>
    <select id="productType">
      <option value="retail_loaf">Retail loaf</option>
      <option value="hospitality_bun">Hospitality bun / roll</option>
      <option value="reseller_line">Reseller line</option>
      <option value="sweet">Sweet / confectionery</option>
      <option value="other">Other</option>
    </select>
    <div class="hint">This changes the “next steps” guidance to suit what the product is meant to do.</div>

    <div id="singleInputs">
      <label for="productName">Product name</label>
      <input id="productName" type="text" placeholder="e.g. Ultimate Burger Bun (clean label)" />

      <label for="strategicRole">Strategic role</label>
      <select id="strategicRole">
        <option value="flagship">Flagship (sets the standard)</option>
        <option value="core">Core range</option>
        <option value="customer_specific">Customer-specific / bespoke</option>
        <option value="commercial_enabler">Commercial enabler (volume / margin support)</option>
        <option value="legacy_review">Legacy (keep under review)</option>
      </select>
      <div class="hint">Helps us see the portfolio, not just the product.</div>

      <label for="decision">Decision</label>
      <select id="decision">
        <option value="proceed">Proceed as is</option>
        <option value="proceed_conditions">Proceed with conditions</option>
        <option value="rework">Rework</option>
        <option value="park">Park / say no (for now)</option>
      </select>

      <label for="direction">Direction of travel</label>
      <select id="direction">
        <option value="improving">Improving</option>
        <option value="stable">Stable</option>
        <option value="declining">Declining</option>
      </select>

      <div class="hint">
        <strong>What this means:</strong> Compared to where this product was 12–24 months ago, are we intentionally moving it closer to our view of good food — or not?<br><br>
        <strong>Improving</strong> = specific changes already made or agreed (not just hoped for).<br>
        <strong>Stable</strong> = deliberately held as it is, for a clear reason.<br>
        <strong>Declining</strong> = a known compromise or legacy product we’re not investing further in.<br><br>
        Choose based on <em>actions taken or agreed</em>, not aspirations.
      </div>

      <div class="divider"></div>

      <label for="ingredients">Ingredients (at time of review)</label>
      <textarea id="ingredients" placeholder="Keep it simple. e.g. Wheat flour, water, butter, yeast, sugar, salt"></textarea>
      <div class="hint">This isn’t a legal label — it’s a record so the PDF makes sense later.</div>

      <label for="processNotes">Process notes (one line)</label>
      <input id="processNotes" type="text" placeholder="e.g. straight dough / overnight ferment / sourdough 24h bulk" />

      <div class="divider"></div>

      <!-- Sliders -->
      <label>1) Customer Need & Insight</label>
      <div class="row">
        <input id="sCustomer" type="range" min="1" max="5" step="1" value="3" />
        <div class="value" id="vCustomer">3</div>
      </div>
      <div class="hint">Is the need clear and real? Are we solving a problem or chasing noise?</div>

      <label>2) Operational Fit</label>
      <div class="row">
        <input id="sOperational" type="range" min="1" max="5" step="1" value="3" />
        <div class="value" id="vOperational">3</div>
      </div>
      <div class="hint">Can we make it well and consistently? Does it flow through the bakery?</div>

      <label>3) Food Quality & Digestibility</label>
      <div class="row">
        <input id="sQuality" type="range" min="1" max="5" step="1" value="3" />
        <div class="value" id="vQuality">3</div>
      </div>
      <div class="hint">Fermentation time/method, wholegrain diversity, fats used, degree of processing (directional).</div>

      <label>4) Resource Impact</label>
      <div class="row">
        <input id="sResource" type="range" min="1" max="5" step="1" value="3" />
        <div class="value" id="vResource">3</div>
      </div>
      <div class="hint">Packaging necessity/type, shelf life vs waste, ingredient efficiency.</div>

      <label>5) Commercial Strength</label>
      <div class="row">
        <input id="sCommercial" type="range" min="1" max="5" step="1" value="3" />
        <div class="value" id="vCommercial">3</div>
      </div>
      <div class="hint">Margin relative to effort, cost volatility, scalability.</div>

      <div class="divider"></div>

      <label for="brandGate">Brand Gate: would we happily explain this product to a customer, face-to-face?</label>
      <select id="brandGate">
        <option value="yes">Yes – proud to put our name to it</option>
        <option value="conditions">Yes – with conditions (needs tweaks)</option>
        <option value="no">No – not something we’d stand behind</option>
      </select>

      <label for="conditions">Conditions / required changes (if any)</label>
      <textarea id="conditions" placeholder="e.g. Swap palm, longer ferment, simplify packaging, improve spec, etc."></textarea>

      <label for="notes">Notes (brief, story, customer context)</label>
      <textarea id="notes" placeholder="Anything useful: customer brief, target use case, operational constraints, etc."></textarea>

      <div class="divider"></div>

      <label>Benchmark overlay</label>
      <div class="row" style="gap:12px; align-items:flex-start;">
        <div style="flex:1">
          <label style="margin:0; color: var(--muted); font-size:12px;">
            <input id="showBenchmark" type="checkbox" style="transform: translateY(1px);" />
            Show “Best of Hobbs House Bakery” overlay
          </label>
          <div class="hint">A reference profile to anchor standards (edit if you want).</div>
        </div>
      </div>

      <div id="benchmarkFields" class="hidden">
        <div class="twoCol">
          <div>
            <label>Benchmark scores (1–5)</label>

            <div class="row">
              <span style="width:95px; color:var(--muted); font-size:12px;">Customer</span>
              <input id="bmkCustomer" type="range" min="1" max="5" step="1" value="5" />
              <div class="value" id="vbmkCustomer">5</div>
            </div>

            <div class="row">
              <span style="width:95px; color:var(--muted); font-size:12px;">Operational</span>
              <input id="bmkOperational" type="range" min="1" max="5" step="1" value="5" />
              <div class="value" id="vbmkOperational">5</div>
            </div>

            <div class="row">
              <span style="width:95px; color:var(--muted); font-size:12px;">Quality</span>
              <input id="bmkQuality" type="range" min="1" max="5" step="1" value="5" />
              <div class="value" id="vbmkQuality">5</div>
            </div>

            <div class="row">
              <span style="width:95px; color:var(--muted); font-size:12px;">Resource</span>
              <input id="bmkResource" type="range" min="1" max="5" step="1" value="5" />
              <div class="value" id="vbmkResource">5</div>
            </div>

            <div class="row">
              <span style="width:95px; color:var(--muted); font-size:12px;">Commercial</span>
              <input id="bmkCommercial" type="range" min="1" max="5" step="1" value="5" />
              <div class="value" id="vbmkCommercial">5</div>
            </div>
          </div>

          <div>
            <label for="benchmarkName">Benchmark name</label>
            <input id="benchmarkName" type="text" value="Best of Hobbs House Bakery" />
            <div class="hint">If you want this to be a specific product (e.g. a flagship sourdough), name it here.</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnGenerate" type="button">Generate chart & insights</button>
        <button class="btn ghost" id="btnReset" type="button">Reset</button>
      </div>

      <div class="footerNote">Scoring guide: 1 = weak, 3 = acceptable, 5 = genuinely strong.</div>
    </div>

    <!-- Compare mode -->
    <div id="compareInputs" class="hidden">
      <div class="twoCol">
        <div>
          <div class="miniTitle">Product A</div>
          <label for="nameA">Name</label>
          <input id="nameA" type="text" placeholder="e.g. Bun A (current)" />

          <label>Customer</label><div class="row"><input id="aCustomer" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vaCustomer">3</div></div>
          <label>Operational</label><div class="row"><input id="aOperational" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vaOperational">3</div></div>
          <label>Quality</label><div class="row"><input id="aQuality" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vaQuality">3</div></div>
          <label>Resource</label><div class="row"><input id="aResource" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vaResource">3</div></div>
          <label>Commercial</label><div class="row"><input id="aCommercial" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vaCommercial">3</div></div>

          <label>Brand Gate</label>
          <select id="aBrand">
            <option value="yes">Yes</option>
            <option value="conditions">Yes (conditions)</option>
            <option value="no">No</option>
          </select>

          <label>Notes</label>
          <textarea id="aNotes" placeholder="Brief notes for A"></textarea>
        </div>

        <div>
          <div class="miniTitle">Product B</div>
          <label for="nameB">Name</label>
          <input id="nameB" type="text" placeholder="e.g. Bun B (clean label + longer ferment)" />

          <label>Customer</label><div class="row"><input id="bCustomer" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vbCustomer">3</div></div>
          <label>Operational</label><div class="row"><input id="bOperational" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vbOperational">3</div></div>
          <label>Quality</label><div class="row"><input id="bQuality" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vbQuality">3</div></div>
          <label>Resource</label><div class="row"><input id="bResource" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vbResource">3</div></div>
          <label>Commercial</label><div class="row"><input id="bCommercial" type="range" min="1" max="5" step="1" value="3"><div class="value" id="vbCommercial">3</div></div>

          <label>Brand Gate</label>
          <select id="bBrand">
            <option value="yes">Yes</option>
            <option value="conditions">Yes (conditions)</option>
            <option value="no">No</option>
          </select>

          <label>Notes</label>
          <textarea id="bNotes" placeholder="Brief notes for B"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnGenerateCompare" type="button">Generate comparison</button>
        <button class="btn ghost" id="btnResetCompare" type="button">Reset</button>
      </div>
    </div>
  </section>

  <!-- RIGHT: Outputs -->
  <section class="gridRight">
    <section class="card chartWrap" aria-label="Chart">
      <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h2 style="margin:0;">Spider chart</h2>
        <div class="hint">No external libraries used — should work anywhere.</div>
      </div>

      <div id="exportArea">
        <div id="chartHolder"></div>
        <div class="chips" id="chips"></div>
      </div>
    </section>

    <section class="card out" aria-label="Insights">
      <h2>What this tells us</h2>
      <div id="summary"></div>

      <div class="divider"></div>

      <h2>Suggested next steps</h2>
      <div id="actions"></div>

      <div class="divider"></div>

      <h2>Scores</h2>
      <div id="scoreTable"></div>
    </section>

    <section class="card out" aria-label="Notes">
      <h2>Notes for the record</h2>
      <div id="notesOut"></div>
    </section>
  </section>
</main>

<script>
  // ---------- Helpers ----------
  const byId = (id) => document.getElementById(id);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  function escapeHtml(str){
    return (str ?? "").toString().replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function classifyScore(n){
    if(n >= 4) return "strong";
    if(n === 3) return "ok";
    return "weak";
  }

  function brandGateLabel(v){
    return v === "yes" ? "Yes" : (v === "no" ? "No" : "Yes (conditions)");
  }
  function decisionLabel(v){
    return v === "proceed" ? "Proceed" :
      (v === "proceed_conditions" ? "Proceed (conditions)" :
      (v === "rework" ? "Rework" : "Park / say no"));
  }
  function directionLabel(v){
    return v === "improving" ? "Improving" : (v === "declining" ? "Declining" : "Stable");
  }
  function roleLabel(v){
    return v === "flagship" ? "Flagship" :
      (v === "core" ? "Core range" :
      (v === "customer_specific" ? "Customer-specific" :
      (v === "commercial_enabler" ? "Commercial enabler" : "Legacy / review")));
  }

  // Product-type nudges
  const typeGuidance = {
    retail_loaf: {
      focus: "Retail loaf focus: repeatable quality, clear story, and ‘quiet differentiators’ (fermentation time / grains) without making health claims.",
      extra: [
        "If it’s a core loaf, aim for consistency first; then improve quality/digestibility directionally.",
        "Make sure the customer benefit is easy to explain in one sentence (taste, keeping quality, digestibility, craft)."
      ]
    },
    hospitality_bun: {
      focus: "Hospitality bun focus: performance and customer brief come first (softness, slicing, freeze/thaw). Improve ‘clean label’ and fermentation directionally without changing the job of the product.",
      extra: [
        "Keep the bun doing its job (soft, reliable, holds fillings). Improve ingredients/process around that.",
        "Aim for ‘better not different’: longer ferment, cleaner fats, tidy-up list, but maintain texture."
      ]
    },
    reseller_line: {
      focus: "Reseller line focus: shelf life / packaging / waste and a simple range that sells. Improvements should be obvious and repeatable.",
      extra: [
        "Prioritise products that tell a clear story and rotate well; avoid range bloat.",
        "Optimise pack formats and shelf life to reduce returns and waste."
      ]
    },
    sweet: {
      focus: "Sweet / confectionery focus: customer joy and quality first. Be intentional about ingredients and processing, without pretending it’s a health product.",
      extra: [
        "Keep claims honest: lead with craft, ingredients and indulgence, not ‘healthy’.",
        "Where appropriate, tidy-up oils and additives, but don’t compromise the eating experience."
      ]
    },
    other: {
      focus: "General focus: be clear what the product is meant to do, then improve it directionally without overcomplicating it.",
      extra: [
        "If the brief is vague, fix that first (who is it for, why does it exist?).",
        "Choose one improvement at a time so changes are understood and repeatable."
      ]
    }
  };

  // ---------- Slider readouts ----------
  const singleSliders = [
    ["sCustomer","vCustomer"], ["sOperational","vOperational"], ["sQuality","vQuality"], ["sResource","vResource"], ["sCommercial","vCommercial"]
  ];
  singleSliders.forEach(([s,o]) => {
    byId(s).addEventListener("input", () => { byId(o).textContent = byId(s).value; if(mode==="single") renderSingle(); });
    byId(o).textContent = byId(s).value;
  });

  const compareSliders = [
    ["aCustomer","vaCustomer"], ["aOperational","vaOperational"], ["aQuality","vaQuality"], ["aResource","vaResource"], ["aCommercial","vaCommercial"],
    ["bCustomer","vbCustomer"], ["bOperational","vbOperational"], ["bQuality","vbQuality"], ["bResource","vbResource"], ["bCommercial","vbCommercial"]
  ];
  compareSliders.forEach(([s,o]) => {
    byId(s).addEventListener("input", () => { byId(o).textContent = byId(s).value; if(mode==="compare") renderCompare(); });
    byId(o).textContent = byId(s).value;
  });

  const bmkSliders = [
    ["bmkCustomer","vbmkCustomer"], ["bmkOperational","vbmkOperational"], ["bmkQuality","vbmkQuality"], ["bmkResource","vbmkResource"], ["bmkCommercial","vbmkCommercial"]
  ];
  bmkSliders.forEach(([s,o]) => {
    byId(s).addEventListener("input", () => { byId(o).textContent = byId(s).value; if(mode==="single") renderSingle(); });
    byId(o).textContent = byId(s).value;
  });

  function syncBenchmarkVisibility(){
    const cb = byId("showBenchmark");
    const box = byId("benchmarkFields");
    box.classList.toggle("hidden", !cb.checked);
  }
  byId("showBenchmark").addEventListener("change", () => { syncBenchmarkVisibility(); renderSingle(); });
  syncBenchmarkVisibility();

  // ---------- SVG Radar Chart ----------
  const dims = ["Customer","Operational","Quality","Resource","Commercial"];

  function polarToXY(cx, cy, r, angleRad){
    return { x: cx + r * Math.cos(angleRad), y: cy + r * Math.sin(angleRad) };
  }

  function buildRadarSVG(series, opts){
    // opts: { title, benchmarkSeries? }
    const size = 420;
    const padding = 46;
    const cx = size/2, cy = size/2;
    const maxR = (size/2) - padding;

    const rings = 5; // 1..5
    const angleStart = -Math.PI / 2; // start at top
    const step = (Math.PI * 2) / dims.length;

    // helper to create polygon points from values [1..5]
    function valuesToPoints(values){
      const pts = values.map((v, i) => {
        const rr = (clamp(v,0,5) / 5) * maxR;
        const a = angleStart + i * step;
        const p = polarToXY(cx, cy, rr, a);
        return `${p.x.toFixed(2)},${p.y.toFixed(2)}`;
      });
      return pts.join(" ");
    }

    // Background grid rings (polygons)
    let grid = "";
    for(let r=1; r<=rings; r++){
      const vals = new Array(dims.length).fill(r);
      grid += `<polygon points="${valuesToPoints(vals)}" fill="none" stroke="rgba(255,255,255,0.10)" stroke-width="1"/>`;
    }

    // Axes + labels
    let axes = "";
    let labels = "";
    for(let i=0; i<dims.length; i++){
      const a = angleStart + i*step;
      const p1 = polarToXY(cx, cy, 0, a);
      const p2 = polarToXY(cx, cy, maxR, a);
      axes += `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="rgba(255,255,255,0.12)" stroke-width="1"/>`;

      const lp = polarToXY(cx, cy, maxR + 22, a);
      labels += `<text x="${lp.x}" y="${lp.y}" text-anchor="middle" dominant-baseline="middle" font-size="12" fill="rgba(255,231,215,0.95)">${dims[i]}</text>`;
    }

    // Series polygons
    const mainPts = valuesToPoints(series.values);
    const main = `
      <polygon points="${mainPts}" fill="rgba(242,106,33,0.22)" stroke="rgba(242,106,33,0.95)" stroke-width="2"/>
      ${series.values.map((v,i)=>{
        const a = angleStart + i*step;
        const rr = (clamp(v,0,5)/5)*maxR;
        const p = polarToXY(cx,cy,rr,a);
        return `<circle cx="${p.x}" cy="${p.y}" r="3.2" fill="rgba(242,106,33,0.95)"/>`;
      }).join("")}
    `;

    let bench = "";
    if(opts && opts.benchmarkSeries){
      const bPts = valuesToPoints(opts.benchmarkSeries.values);
      bench = `
        <polygon points="${bPts}" fill="none" stroke="rgba(255,255,255,0.75)" stroke-width="2" stroke-dasharray="7 5"/>
      `;
    }

    const title = opts?.title ? `<text x="${cx}" y="20" text-anchor="middle" font-size="13" fill="rgba(157,176,198,0.95)">${escapeHtml(opts.title)}</text>` : "";

    return `
      <svg id="radarSVG" xmlns="http://www.w3.org/2000/svg" width="100%" viewBox="0 0 ${size} ${size}" role="img" aria-label="Spider chart">
        <rect x="0" y="0" width="${size}" height="${size}" rx="16" ry="16" fill="rgba(0,0,0,0.12)" stroke="rgba(255,255,255,0.08)"/>
        ${title}
        <g>${grid}${axes}${labels}</g>
        <g>${bench}${main}</g>

        <g>
          <text x="${size-14}" y="${size-14}" text-anchor="end" font-size="11" fill="rgba(157,176,198,0.85)">Scale: 1–5</text>
        </g>
      </svg>
    `;
  }

  // ---------- Data getters ----------
  function getSingleData(){
    return {
      productType: byId("productType").value,
      productName: byId("productName").value.trim(),
      strategicRole: byId("strategicRole").value,
      decision: byId("decision").value,
      direction: byId("direction").value,
      ingredients: byId("ingredients").value,
      processNotes: byId("processNotes").value,

      customer: +byId("sCustomer").value,
      operational: +byId("sOperational").value,
      quality: +byId("sQuality").value,
      resource: +byId("sResource").value,
      commercial: +byId("sCommercial").value,

      brandGate: byId("brandGate").value,
      conditions: byId("conditions").value,
      notes: byId("notes").value,

      showBenchmark: byId("showBenchmark").checked,
      benchmarkName: byId("benchmarkName").value.trim() || "Best of Hobbs House Bakery",
      bmkCustomer: +byId("bmkCustomer").value,
      bmkOperational: +byId("bmkOperational").value,
      bmkQuality: +byId("bmkQuality").value,
      bmkResource: +byId("bmkResource").value,
      bmkCommercial: +byId("bmkCommercial").value
    };
  }

  function getCompareData(){
    return {
      productType: byId("productType").value,
      a: {
        name: byId("nameA").value.trim(),
        customer:+byId("aCustomer").value,
        operational:+byId("aOperational").value,
        quality:+byId("aQuality").value,
        resource:+byId("aResource").value,
        commercial:+byId("aCommercial").value,
        brandGate: byId("aBrand").value,
        notes: byId("aNotes").value
      },
      b: {
        name: byId("nameB").value.trim(),
        customer:+byId("bCustomer").value,
        operational:+byId("bOperational").value,
        quality:+byId("bQuality").value,
        resource:+byId("bResource").value,
        commercial:+byId("bCommercial").value,
        brandGate: byId("bBrand").value,
        notes: byId("bNotes").value
      }
    };
  }

  // ---------- Outputs ----------
  function renderChipsSingle(data){
    const chipWrap = byId("chips");
    chipWrap.innerHTML = "";

    const items = [
      ["Customer", data.customer],
      ["Operational", data.operational],
      ["Quality", data.quality],
      ["Resource", data.resource],
      ["Commercial", data.commercial]
    ];

    for(const [name,val] of items){
      const c = classifyScore(val);
      const chip = document.createElement("div");
      chip.className = "chip " + (c==="strong" ? "good" : (c==="weak" ? "bad" : "warn"));
      chip.textContent = `${name}: ${val}/5`;
      chipWrap.appendChild(chip);
    }

    const gateChip = document.createElement("div");
    gateChip.className = "chip " + (data.brandGate==="yes" ? "good" : (data.brandGate==="no" ? "bad" : "warn"));
    gateChip.textContent = `Brand Gate: ${brandGateLabel(data.brandGate)}`;
    chipWrap.appendChild(gateChip);

    const d1 = document.createElement("div");
    d1.className = "chip";
    d1.textContent = `Decision: ${decisionLabel(data.decision)}`;
    chipWrap.appendChild(d1);

    const d2 = document.createElement("div");
    d2.className = "chip";
    d2.textContent = `Direction: ${directionLabel(data.direction)}`;
    chipWrap.appendChild(d2);

    const d3 = document.createElement("div");
    d3.className = "chip";
    d3.textContent = `Role: ${roleLabel(data.strategicRole)}`;
    chipWrap.appendChild(d3);
  }

  function scoreTableSingle(data){
    const rows = [
      ["Customer Need & Insight", data.customer],
      ["Operational Fit", data.operational],
      ["Food Quality & Digestibility", data.quality],
      ["Resource Impact", data.resource],
      ["Commercial Strength", data.commercial],
      ["Brand Gate", brandGateLabel(data.brandGate)],
      ["Decision", decisionLabel(data.decision)],
      ["Strategic role", roleLabel(data.strategicRole)],
      ["Direction of travel", directionLabel(data.direction)]
    ];
    return `<ul>${rows.map(r => `<li><strong>${r[0]}:</strong> ${escapeHtml(r[1])}</li>`).join("")}</ul>`;
  }

  function notesOutputSingle(data){
    const typeTxt = byId("productType").options[byId("productType").selectedIndex].text;
    const ingred = (data.ingredients||"").trim();
    const cond = (data.conditions||"").trim();
    const notes = (data.notes||"").trim();

    return `
      <p><strong>Product type:</strong> ${escapeHtml(typeTxt)}</p>
      <p><strong>Strategic role:</strong> ${escapeHtml(roleLabel(data.strategicRole))} • <strong>Decision:</strong> ${escapeHtml(decisionLabel(data.decision))} • <strong>Direction:</strong> ${escapeHtml(directionLabel(data.direction))}</p>
      <p><strong>Process notes:</strong> ${data.processNotes ? escapeHtml(data.processNotes) : "None recorded."}</p>
      <p><strong>Ingredients (at time of review):</strong><br>${ingred ? escapeHtml(ingred).replace(/\n/g,"<br>") : "None recorded."}</p>
      <p><strong>Conditions / required changes:</strong><br>${cond ? escapeHtml(cond).replace(/\n/g,"<br>") : "None recorded."}</p>
      <p><strong>Notes:</strong><br>${notes ? escapeHtml(notes).replace(/\n/g,"<br>") : "None recorded."}</p>
    `;
  }

  function summarySingle(data){
    const scores = [
      { name:"Customer need", val:data.customer },
      { name:"Operational fit", val:data.operational },
      { name:"Food quality/digestibility", val:data.quality },
      { name:"Resource impact", val:data.resource },
      { name:"Commercial strength", val:data.commercial }
    ];
    const strong = scores.filter(s => s.val >= 4);
    const weak = scores.filter(s => s.val <= 2);
    const productLabel = data.productName ? `“${escapeHtml(data.productName)}”` : "This product";

    const g = typeGuidance[data.productType] || typeGuidance.other;

    let lines = [];
    lines.push(`<p><strong>Decision:</strong> ${escapeHtml(decisionLabel(data.decision))} • <strong>Strategic role:</strong> ${escapeHtml(roleLabel(data.strategicRole))} • <strong>Direction:</strong> ${escapeHtml(directionLabel(data.direction))}</p>`);

    if(data.brandGate === "no"){
      lines.push(`<p><strong>${productLabel}</strong> fails the Brand Gate right now. Treat this as a rework/repositioning job before we go further.</p>`);
    } else if(data.brandGate === "conditions"){
      lines.push(`<p><strong>${productLabel}</strong> is broadly on track, but there are conditions to fix before we’d stand behind it confidently.</p>`);
    } else {
      lines.push(`<p><strong>${productLabel}</strong> clears the Brand Gate. The main question is whether the trade-offs are right for the customer and the business.</p>`);
    }

    if(strong.length){
      lines.push(`<p><strong>Key strengths:</strong> ${strong.map(s => s.name).join(", ")}.</p>`);
    } else {
      lines.push(`<p><strong>No clear spikes</strong> yet — balanced, but not distinctive. That’s fine for some products, but it may not be memorable.</p>`);
    }

    if(weak.length){
      lines.push(`<p><strong>Key gaps:</strong> ${weak.map(s => s.name).join(", ")}. These are your most likely levers.</p>`);
    } else {
      lines.push(`<p><strong>No major red flags</strong> (nothing scoring 1–2). Improvements can be incremental rather than urgent.</p>`);
    }

    lines.push(`<p><strong>Type context:</strong> ${escapeHtml(g.focus)}</p>`);
    lines.push(`<p><strong>Useful reminder:</strong> Not every product needs to be strong in every area. What matters is that the trade-offs are conscious, and directionally we’re moving the right way.</p>`);

    return lines.join("");
  }

  function actionListSingle(data){
    const actions = [];
    const weak = (v) => v <= 2;

    if(data.decision === "park"){
      actions.push("Park it for now: capture what would need to change for this to become viable, and what signal would trigger a revisit.");
    }
    if(data.decision === "rework"){
      actions.push("Rework the brief: agree the one or two changes that would most improve this product without changing what it’s meant to do.");
    }
    if(data.decision === "proceed_conditions"){
      actions.push("Proceed with conditions: write the conditions clearly, assign owners, and set a review date.");
    }

    if(data.brandGate === "no"){
      actions.push("Agree what would make us proud of it (ingredients, process, story, or customer fit). If that can’t be achieved, treat it as a conscious exception and name it as such.");
    } else if(data.brandGate === "conditions"){
      actions.push("Write the conditions clearly (one line each) and assign owners + deadlines. Keep it specific: ‘swap X’, ‘add Y ferment’, ‘remove Z’, ‘change pack format’.");
    }

    if(weak(data.customer)) actions.push("Strengthen the brief: who is it for, what problem does it solve, and what does success look like (taste / performance / price / shelf life)?");
    if(weak(data.operational)) actions.push("Make it more repeatable: simplify method, reduce fragility, or adjust timings so it fits the bakery rhythm.");
    if(weak(data.quality)) actions.push("Find a ‘better not different’ improvement: longer fermentation, cleaner fat choice, modest wholegrain uplift, or remove unnecessary additives (without breaking the product’s role).");
    if(weak(data.resource)) actions.push("Reduce waste and packaging impact: improve shelf life, change pack format, or simplify materials. Focus on what we can directly control.");
    if(weak(data.commercial)) actions.push("Rebuild the commercial case: margin vs effort. Either re-price, simplify spec, or agree it’s a strategic product with a deliberate trade-off.");

    const anyWeak = weak(data.customer)||weak(data.operational)||weak(data.quality)||weak(data.resource)||weak(data.commercial);
    if(!anyWeak) actions.push("This is in decent shape. Choose one directional improvement (only one) to make it stronger over time.");

    const g = typeGuidance[data.productType] || typeGuidance.other;
    g.extra.forEach(x => actions.push(x));

    return `<ul>${actions.map(a => `<li>${escapeHtml(a)}</li>`).join("")}</ul>`;
  }

  // Compare summaries
  function compareSummaryBlock(label, d){
    const scores = [
      ["Customer", d.customer],
      ["Operational", d.operational],
      ["Quality", d.quality],
      ["Resource", d.resource],
      ["Commercial", d.commercial]
    ];
    const strong = scores.filter(s => s[1] >= 4).map(s => s[0]);
    const weak = scores.filter(s => s[1] <= 2).map(s => s[0]);
    const name = d.name ? escapeHtml(d.name) : label;

    return `
      <div class="card" style="box-shadow:none; background: rgba(0,0,0,.12); border:1px solid rgba(255,255,255,.10)">
        <div class="miniTitle">${name}</div>
        <p><strong>Brand Gate:</strong> ${escapeHtml(brandGateLabel(d.brandGate))}</p>
        <p><strong>Strengths:</strong> ${strong.length ? strong.join(", ") : "none obvious yet"}.</p>
        <p><strong>Gaps:</strong> ${weak.length ? weak.join(", ") : "no major red flags"}.</p>
        ${d.notes.trim() ? `<p><strong>Notes:</strong><br>${escapeHtml(d.notes).replace(/\n/g,"<br>")}</p>` : ``}
      </div>
    `;
  }

  function compareActions(a,b,productType){
    const dimsK = [
      ["Customer", "customer"],
      ["Operational", "operational"],
      ["Quality", "quality"],
      ["Resource", "resource"],
      ["Commercial", "commercial"]
    ];
    const winsA = [], winsB = [], ties = [];
    for(const [name,k] of dimsK){
      if(a[k] > b[k]) winsA.push(name);
      else if(b[k] > a[k]) winsB.push(name);
      else ties.push(name);
    }

    const g = typeGuidance[productType] || typeGuidance.other;
    const recs = [];

    if(a.brandGate === "no" && b.brandGate !== "no"){
      recs.push("Product A fails the Brand Gate. Unless there’s a strong reason, prioritise B or rework A first.");
    } else if(b.brandGate === "no" && a.brandGate !== "no"){
      recs.push("Product B fails the Brand Gate. Unless there’s a strong reason, prioritise A or rework B first.");
    }

    if(winsA.length || winsB.length){
      recs.push(`Where they differ: ${winsA.length ? `A is stronger on ${winsA.join(", ")}` : ""}${winsA.length && winsB.length ? " / " : ""}${winsB.length ? `B is stronger on ${winsB.join(", ")}` : ""}.`);
    }
    if(ties.length) recs.push(`Similar on: ${ties.join(", ")}.`);

    recs.push(g.focus);
    recs.push("If this is a recipe-change decision, keep the product’s job the same and improve one thing at a time (so we know what actually made it better).");

    return `<ul>${recs.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`;
  }

  // ---------- Render ----------
  function renderSingle(){
    const data = getSingleData();

    const series = { name: data.productName || "Product", values: [data.customer, data.operational, data.quality, data.resource, data.commercial] };
    const opts = { title: series.name };
    if(data.showBenchmark){
      opts.benchmarkSeries = { name: data.benchmarkName, values: [data.bmkCustomer, data.bmkOperational, data.bmkQuality, data.bmkResource, data.bmkCommercial] };
      opts.title = `${series.name} (with benchmark overlay)`;
    }

    byId("chartHolder").innerHTML = buildRadarSVG(series, opts);
    renderChipsSingle(data);

    byId("summary").innerHTML = summarySingle(data);
    byId("actions").innerHTML = actionListSingle(data);
    byId("scoreTable").innerHTML = scoreTableSingle(data);
    byId("notesOut").innerHTML = notesOutputSingle(data);
  }

  function renderCompare(){
    const data = getCompareData();
    const a = data.a, b = data.b;

    const series = { name: a.name || "Product A", values: [a.customer,a.operational,a.quality,a.resource,a.commercial] };
    const opts = { title: "Compare mode (A vs B)" };

    // In compare mode, show A as main and B as dashed overlay
    opts.benchmarkSeries = { name: b.name || "Product B", values: [b.customer,b.operational,b.quality,b.resource,b.commercial] };

    byId("chartHolder").innerHTML = buildRadarSVG(series, opts);

    byId("chips").innerHTML = `
      <div class="chip warn">Mode: Compare</div>
      <div class="chip">A: ${escapeHtml(a.name || "Product A")}</div>
      <div class="chip">B: ${escapeHtml(b.name || "Product B")}</div>
    `;

    byId("summary").innerHTML = `
      <div class="twoCol">
        ${compareSummaryBlock("Product A", a)}
        ${compareSummaryBlock("Product B", b)}
      </div>
    `;

    byId("actions").innerHTML = compareActions(a,b,data.productType);

    // reuse a simple score list
    const scoreList = (x) => `<ul>
      <li><strong>Customer:</strong> ${x.customer}</li>
      <li><strong>Operational:</strong> ${x.operational}</li>
      <li><strong>Quality:</strong> ${x.quality}</li>
      <li><strong>Resource:</strong> ${x.resource}</li>
      <li><strong>Commercial:</strong> ${x.commercial}</li>
      <li><strong>Brand Gate:</strong> ${escapeHtml(brandGateLabel(x.brandGate))}</li>
    </ul>`;

    byId("scoreTable").innerHTML = `
      <div class="twoCol">
        <div><div class="miniTitle">A</div>${scoreList(a)}</div>
        <div><div class="miniTitle">B</div>${scoreList(b)}</div>
      </div>
    `;

    const typeTxt = byId("productType").options[byId("productType").selectedIndex].text;
    byId("notesOut").innerHTML = `
      <p><strong>Product type:</strong> ${escapeHtml(typeTxt)}</p>
      <p><strong>Notes A:</strong><br>${escapeHtml(a.notes||"None") .replace(/\n/g,"<br>")}</p>
      <p><strong>Notes B:</strong><br>${escapeHtml(b.notes||"None") .replace(/\n/g,"<br>")}</p>
    `;
  }

  // ---------- Mode switching ----------
  const tabSingle = byId("tabSingle");
  const tabCompare = byId("tabCompare");
  const singleInputs = byId("singleInputs");
  const compareInputs = byId("compareInputs");
  let mode = "single";

  function setMode(next){
    mode = next;
    const isSingle = mode === "single";
    tabSingle.classList.toggle("active", isSingle);
    tabCompare.classList.toggle("active", !isSingle);
    tabSingle.setAttribute("aria-selected", isSingle);
    tabCompare.setAttribute("aria-selected", !isSingle);
    singleInputs.classList.toggle("hidden", !isSingle);
    compareInputs.classList.toggle("hidden", isSingle);

    if(isSingle) renderSingle(); else renderCompare();
  }

  tabSingle.addEventListener("click", () => setMode("single"));
  tabCompare.addEventListener("click", () => setMode("compare"));
  byId("productType").addEventListener("change", () => { if(mode==="single") renderSingle(); else renderCompare(); });

  // ---------- Buttons ----------
  byId("btnGenerate").addEventListener("click", renderSingle);
  byId("btnGenerateCompare").addEventListener("click", renderCompare);

  byId("btnReset").addEventListener("click", () => {
    byId("productType").value = "retail_loaf";
    byId("productName").value = "";
    byId("strategicRole").value = "core";
    byId("decision").value = "proceed";
    byId("direction").value = "stable";
    byId("ingredients").value = "";
    byId("processNotes").value = "";

    byId("sCustomer").value = 3; byId("vCustomer").textContent = 3;
    byId("sOperational").value = 3; byId("vOperational").textContent = 3;
    byId("sQuality").value = 3; byId("vQuality").textContent = 3;
    byId("sResource").value = 3; byId("vResource").textContent = 3;
    byId("sCommercial").value = 3; byId("vCommercial").textContent = 3;

    byId("brandGate").value = "yes";
    byId("conditions").value = "";
    byId("notes").value = "";

    byId("showBenchmark").checked = false;
    syncBenchmarkVisibility();
    byId("benchmarkName").value = "Best of Hobbs House Bakery";
    byId("bmkCustomer").value = 5; byId("vbmkCustomer").textContent = 5;
    byId("bmkOperational").value = 5; byId("vbmkOperational").textContent = 5;
    byId("bmkQuality").value = 5; byId("vbmkQuality").textContent = 5;
    byId("bmkResource").value = 5; byId("vbmkResource").textContent = 5;
    byId("bmkCommercial").value = 5; byId("vbmkCommercial").textContent = 5;

    renderSingle();
  });

  byId("btnResetCompare").addEventListener("click", () => {
    byId("productType").value = "hospitality_bun";
    byId("nameA").value = "";
    byId("nameB").value = "";
    byId("aNotes").value = "";
    byId("bNotes").value = "";
    ["aCustomer","aOperational","aQuality","aResource","aCommercial","bCustomer","bOperational","bQuality","bResource","bCommercial"].forEach(id => byId(id).value = 3);
    ["vaCustomer","vaOperational","vaQuality","vaResource","vaCommercial","vbCustomer","vbOperational","vbQuality","vbResource","vbCommercial"].forEach(id => byId(id).textContent = 3);
    byId("aBrand").value = "yes";
    byId("bBrand").value = "yes";
    renderCompare();
  });

  // ---------- Save/Load + JSON ----------
  const LS_KEY = "hhb_product_balance_offline_v1";

  function currentState(){
    if(mode === "single") return { mode, ...getSingleData() };
    const c = getCompareData();
    return { mode, ...c };
  }

  function applyState(state){
    if(!state || !state.mode) return;
    setMode(state.mode);
    byId("productType").value = state.productType || "retail_loaf";

    if(state.mode === "single"){
      byId("productName").value = state.productName || "";
      byId("strategicRole").value = state.strategicRole || "core";
      byId("decision").value = state.decision || "proceed";
      byId("direction").value = state.direction || "stable";
      byId("ingredients").value = state.ingredients || "";
      byId("processNotes").value = state.processNotes || "";

      byId("sCustomer").value = state.customer ?? 3; byId("vCustomer").textContent = byId("sCustomer").value;
      byId("sOperational").value = state.operational ?? 3; byId("vOperational").textContent = byId("sOperational").value;
      byId("sQuality").value = state.quality ?? 3; byId("vQuality").textContent = byId("sQuality").value;
      byId("sResource").value = state.resource ?? 3; byId("vResource").textContent = byId("sResource").value;
      byId("sCommercial").value = state.commercial ?? 3; byId("vCommercial").textContent = byId("sCommercial").value;

      byId("brandGate").value = state.brandGate || "yes";
      byId("conditions").value = state.conditions || "";
      byId("notes").value = state.notes || "";

      byId("showBenchmark").checked = !!state.showBenchmark;
      syncBenchmarkVisibility();
      byId("benchmarkName").value = state.benchmarkName || "Best of Hobbs House Bakery";

      byId("bmkCustomer").value = state.bmkCustomer ?? 5; byId("vbmkCustomer").textContent = byId("bmkCustomer").value;
      byId("bmkOperational").value = state.bmkOperational ?? 5; byId("vbmkOperational").textContent = byId("bmkOperational").value;
      byId("bmkQuality").value = state.bmkQuality ?? 5; byId("vbmkQuality").textContent = byId("bmkQuality").value;
      byId("bmkResource").value = state.bmkResource ?? 5; byId("vbmkResource").textContent = byId("bmkResource").value;
      byId("bmkCommercial").value = state.bmkCommercial ?? 5; byId("vbmkCommercial").textContent = byId("bmkCommercial").value;

      renderSingle();
    } else {
      const a = state.a || {};
      const b = state.b || {};
      byId("nameA").value = a.name || "";
      byId("nameB").value = b.name || "";

      byId("aCustomer").value = a.customer ?? 3; byId("vaCustomer").textContent = byId("aCustomer").value;
      byId("aOperational").value = a.operational ?? 3; byId("vaOperational").textContent = byId("aOperational").value;
      byId("aQuality").value = a.quality ?? 3; byId("vaQuality").textContent = byId("aQuality").value;
      byId("aResource").value = a.resource ?? 3; byId("vaResource").textContent = byId("aResource").value;
      byId("aCommercial").value = a.commercial ?? 3; byId("vaCommercial").textContent = byId("aCommercial").value;
      byId("aBrand").value = a.brandGate || "yes";
      byId("aNotes").value = a.notes || "";

      byId("bCustomer").value = b.customer ?? 3; byId("vbCustomer").textContent = byId("bCustomer").value;
      byId("bOperational").value = b.operational ?? 3; byId("vbOperational").textContent = byId("bOperational").value;
      byId("bQuality").value = b.quality ?? 3; byId("vbQuality").textContent = byId("bQuality").value;
      byId("bResource").value = b.resource ?? 3; byId("vbResource").textContent = byId("bResource").value;
      byId("bCommercial").value = b.commercial ?? 3; byId("vbCommercial").textContent = byId("bCommercial").value;
      byId("bBrand").value = b.brandGate || "yes";
      byId("bNotes").value = b.notes || "";

      renderCompare();
    }
  }

  byId("btnSaveLocal").addEventListener("click", () => {
    localStorage.setItem(LS_KEY, JSON.stringify(currentState()));
    alert("Saved.");
  });

  byId("btnLoadLocal").addEventListener("click", () => {
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return alert("Nothing saved yet.");
    applyState(JSON.parse(raw));
    alert("Loaded.");
  });

  byId("btnExportJSON").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(currentState(), null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `hhb-product-balance-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  byId("btnImportJSON").addEventListener("click", () => byId("jsonFile").click());
  byId("jsonFile").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const text = await file.text();
    try{
      applyState(JSON.parse(text));
      alert("Imported.");
    }catch(err){
      alert("Could not import that JSON file.");
    }finally{
      e.target.value = "";
    }
  });

  // ---------- Download chart SVG ----------
  byId("btnDownloadSVG").addEventListener("click", () => {
    const svg = byId("radarSVG");
    if(!svg) return alert("No chart yet — click Generate first.");
    const serializer = new XMLSerializer();
    const svgText = serializer.serializeToString(svg);

    const blob = new Blob([svgText], {type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `hhb-spider-chart-${new Date().toISOString().slice(0,10)}.svg`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // ---------- Print / Save as PDF ----------
  byId("btnPrintPDF").addEventListener("click", () => {
    window.print();
  });

  // ---------- Init ----------
  setMode("single");
  renderSingle();
</script>
</body>
</html>
